FROM cm2network/steamcmd:root

LABEL org.opencontainers.image.authors="github.com/XavierSJC"

ENV SERVER_NAME=Your_name_server
ENV SERVER_PORT=7777
ENV RCON_PWD=ChangeThisPassword
ENV RCON_PORT=9100
ENV UPDATE_SERVER=True
ENV SHUFFLE_MAPS=False
ENV STATS_ENDPOINT=/api/PavlovShackStats/

# Install pavlov server dependencies
RUN apt update && apt install -y gdb curl lib32gcc-s1 libc++-dev
RUN rm /usr/lib/x86_64-linux-gnu/libc++.so
RUN ln -s /usr/lib/x86_64-linux-gnu/libc++.so.1 /usr/lib/x86_64-linux-gnu/libc++.so

USER steam

# Install Pavlov Server
COPY --chown=steam:steam ../configfiles/install_pavlov_shack.sh /home/steam/pavlovserver/
RUN chmod +x /home/steam/pavlovserver/install_pavlov_shack.sh
RUN /home/steam/pavlovserver/install_pavlov_shack.sh

# Server configuration
RUN mkdir -p /home/steam/pavlovserver/Pavlov/Saved/Logs
RUN mkdir -p /home/steam/pavlovserver/Pavlov/Saved/Config/LinuxServer
RUN mkdir -p /home/steam/pavlovserver/Pavlov/Saved/maps

RUN touch /home/steam/pavlovserver/Pavlov/Saved/Config/mods.txt
RUN touch /home/steam/pavlovserver/Pavlov/Saved/Config/blacklist.txt
RUN touch /home/steam/pavlovserver/Pavlov/Saved/Config/whitelist.txt

# Configuration and map list
COPY --chown=steam:steam ../configfiles/Game.ini /home/steam/pavlovserver/Pavlov/Saved/Config/LinuxServer/
COPY --chown=steam:steam ../configfiles/shuffleMaps.sh /home/steam/pavlovserver/
RUN chmod +x /home/steam/pavlovserver/shuffleMaps.sh

# Configure RCON
COPY --chown=steam:steam ../configfiles/RconSettings.txt /home/steam/pavlovserver/Pavlov/Saved/Config/
# Configure stats export
COPY --chown=steam:steam ../configfiles/ExportPavlovShackStats.sh /home/steam/pavlovserver/
RUN chmod +x /home/steam/pavlovserver/ExportPavlovShackStats.sh

# Configure main script that runs server
COPY --chown=steam:steam ../configfiles/ConfigureServer.sh /home/steam/pavlovserver/
RUN chmod +x /home/steam/pavlovserver/ConfigureServer.sh

EXPOSE 7777 7777/udp 8177 8177/udp 9100

ENTRYPOINT ["/home/steam/pavlovserver/ConfigureServer.sh"]